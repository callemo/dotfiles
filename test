#!/bin/sh
# test - run basic tests for dotfiles programs

: "${DOTFILES:=$(pwd)}"

normalize() {
	sed -e 's|/tmp/test1\.[0-9]*|TMPFILE|g' \
	    -e 's|/tmp/rgsub_test\.[0-9]*|TESTDIR|g' | sed -n l
}

case "${1:-}" in
-g)
	if ! output=$(PYTHONPATH=$DOTFILES python3 -m unittest test_snip.py 2>&1); then
		echo "Unit tests failed" >&2
		echo "$output" >&2
		exit 1
	fi
	env - PATH="$DOTFILES/bin:$PATH" HOME="$HOME" DOTFILES="$DOTFILES" sh test.sh 2>&1 |
		normalize >test.exp
	echo "Generated test.exp"
	;;
*)
	if ! output=$(PYTHONPATH=$DOTFILES python3 -m unittest test_snip.py 2>&1); then
		echo "Unit tests failed" >&2
		echo "$output" >&2
		exit 1
	fi
	out=$(mktemp)
	trap 'rm -f "$out"' EXIT
	env - PATH="$DOTFILES/bin:$PATH" HOME="$HOME" DOTFILES="$DOTFILES" sh test.sh 2>&1 |
		normalize >"$out"
	diff -u test.exp "$out"
	;;
esac
