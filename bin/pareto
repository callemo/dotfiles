#!/bin/sh
# usage: pareto [-n column] [files...]
# Summarizes numeric columns with percent and cumulative percent
# of the total.
#
# Options:
#   -n N    Column number to analyze (default: 1)

usage() { sed -En '2,/^[^#]/ s/^# //p' "$0" >&2; }

while getopts :n:h f
do
	case $f in
	h)  usage; exit 0;;
	n)  narg=$OPTARG;;
	\?) usage; exit 2;;
	esac
done
shift $((OPTIND - 1))

awk 'BEGIN {
n = '"${narg:-1}"'
tab = sprintf("\t")
}
{
line[NR] = $0
num[NR] = $n + 0
sum += num[NR]
csum[NR] = sum
}
END {
for (i = 1; i <= NR; i++) {
    nf = split(line[i], a)
    p = int(num[i] / sum * 100 + 0.5)
    cp = int(csum[i] / sum * 100 + 0.5)
    out = ""
    for (j = 1; j <= nf; j++) {
        if (j == 1) {
            out = a[j]
        } else {
            out = out tab a[j]
        }
        if (j == n) {
            out = out tab p "%" tab cp "%"
        }
    }
    if (n > nf) {
        out = out tab p "%" tab cp "%"
    }
    print out
}
}' "$@"
