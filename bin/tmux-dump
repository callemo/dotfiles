#!/bin/sh
# tmux-dump: saves a tmux session

prefix="${0##*/}:"
log() { echo "$prefix" "$@" >&2; }
fatal() { log "$@"; exit 1; }

f="${1:-$HOME/tmux.dump}"
t=/tmp/tmux-dump.$$
trap 'rm -f "$t"' 0

{
	tmux display -p '#{session_path}' || fatal 'no session'

    tmux lsw -F '#{window_index}	#{window_flags}	#{window_name}	#{window_layout}' |
        awk 'BEGIN { FS = OFS = "\t" }
        	{ "tmux show -w -v -t " $1 " automatic-rename" | getline ar
        	print "w", $1, $2, $3, ar, $4 }' |
        awk 'BEGIN { f = "#{window_index}	#{pane_index}	#{pane_current_path}" }
		    { system("tmux lsp -t " $2 " -F '\''" f "'\''") }'
} >"$t"
cat "$t" >"$f"
