#!/bin/sh
# tmux-dump: saves a tmux session

prefix="${0##*/}:"
log() { echo "$prefix" "$@" >&2; }
fatal() { log "$@"; exit 1; }

f="${1:-$HOME/tmux.dump}"

t=/tmp/tmux-dump.$$
trap 'rm -f "$t"' 0

path=$(tmux display -p '#{session_path}')
[ -z "$path" ] && fatal 'no session path'
name=$(tmux display -p '#{session_name}')
[ -z "$name" ] && fatal 'no session name'

{
	echo "$path"
	echo "$name"

    d='          '
    tmux lsw -F '#{window_index}'"$d"'#{window_flags}'"$d"'#{window_name}'"$d"'#{window_layout}' |
        awk 'BEGIN { FS = OFS = "'"$d"'" }
             { "tmux show -w -v -t '"$name"':" $1 " automatic-rename" | getline ar
               print "w", $1, $2, $3, ar, $4 }' |
        awk 'BEGIN { f = "p'"$d"'#{window_index}'"$d"'#{pane_index}'"$d"'#{pane_current_path}" }
		     { windows[NR] = $0
		       system("tmux lsp -t " $2 " -F '\''" f "'\''") }
		     END { for (i = 1; i <= NR; i++)
		               print(windows[i]) }'
} >"$t"
cat "$t" >"$f"
