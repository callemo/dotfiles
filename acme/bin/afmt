#!/bin/sh
# Automatic code reformatting. It depends on formatters being installed.

tmp="$(mktemp)"
errtmp="$(mktemp)"
trap 'rm "$tmp" "$errtmp"' 0

type="${samfile##*.}"
case $type in
go)
	9p read "acme/$winid/body" | goimports 2>"$errtmp" >"$tmp" || {
		sed 's|<standard input>|'"$samfile"'|' "$errtmp" >&2
		echo 'afmt: goimports error' >&2
		exit 1
	};;
py)
	9p read "acme/$winid/body" | black --stdin-filename "$samfile" -q - >"$tmp" || {
		echo 'afmt: black error' >&2
		exit 1
	};;
*)
	9p read "acme/$winid/body" | prettier --stdin-filepath "$samfile" >"$tmp" || {
		echo 'afmt: prettier error' >&2
		exit 1
	};;
esac

9p read "acme/$winid/body" | cmp -s - "$tmp" && exit

printf mark | 9p write "acme/$winid/ctl"
printf nomark | 9p write "acme/$winid/ctl"
printf , | 9p write "acme/$winid/addr"
9p write "acme/$winid/data" <"$tmp"
printf mark | 9p write "acme/$winid/ctl"
