#!/bin/sh
# usage: afmt [-d]
# Automatic code reformatting. It depends on formatters being installed.
# Flags:
#  -d Show differences.

for x
do
	case $x in
	-d) dflag=$x
	esac
done

in=/tmp/afmtin.$$
out=/tmp/afmtout.$$
err=/tmp/afmterr.$$
trap 'rm -f "$in" "$out" "$err"; exit 1' 1 2 15

9p read "acme/$winid/body" >"$in"
type="${samfile##*.}"
case $type in
go)
	goimports <"$in" >"$out" 2>"$err" || {
		sed 's@<standard input>@'"$samfile"'@' "$err" >&2
		echo 'afmt: goimports error' >&2
		exit 1
	};;
py)
	black --stdin-filename "$samfile" -q - <"$in" >"$out" || {
		echo 'afmt: black error' >&2
		exit 1
	};;
rs)
	rustfmt <"$in" >"$out" 2>"$err" || {
		sed 's@<stdin>@'"$samfile"'@' "$err" >&2
		echo 'afmt: rustfmt error' >&2
		exit 1
	};;
*)
	prettier --print-width 100 --tab-width 4 --stdin-filepath "$samfile" <"$in" >"$out" || {
		echo 'afmt: prettier error' >&2
		exit 1
	};;
esac

if [ -n "$dflag" ]
then
	diff -u "$in" "$out" && { rm -f "$in" "$out" "$err"; exit; }
else
	cmp -s "$in" "$out" && { rm -f "$in" "$out" "$err"; exit; }
fi

printf mark | 9p write "acme/$winid/ctl"
printf nomark | 9p write "acme/$winid/ctl"
printf , | 9p write "acme/$winid/addr"
9p write "acme/$winid/data" <"$out"
printf mark | 9p write "acme/$winid/ctl"
printf '#0' | 9p write "acme/$winid/addr"
printf dot=addr | 9p write "acme/$winid/ctl"
printf show | 9p write "acme/$winid/ctl"
rm -f "$in" "$out" "$err"
